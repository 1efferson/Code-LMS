<!-- course_students.html (UPDATED WITH MESSAGING) -->

{% extends "base.html" %}
{% block content %}

<div class="min-h-screen bg-gray-100 dark:bg-gray-950 px-4 sm:px-8 py-10">

  <div class="max-w-7xl mx-auto flex flex-col min-h-[calc(100vh-64px)]">

    <!-- PAGE HEADER -->
    <header class="mb-8">
      <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-gray-100">
        Enrolled Students
      </h2>
      <p class="mt-1 text-gray-600 dark:text-gray-400">
        {{ course.title }}
      </p>
    </header>

    <!-- SEARCH + FILTER -->
    <section class="mb-6 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">

      <div class="relative w-full sm:max-w-xs">
        <input
          type="text"
          placeholder="Search students…"
          class="w-full rounded-md border border-gray-300 dark:border-gray-700
                 bg-white/80 dark:bg-gray-900/70 backdrop-blur
                 px-4 py-2 text-sm text-gray-900 dark:text-gray-100
                 placeholder-gray-500 dark:placeholder-gray-500
                 focus:outline-none focus:ring-2 focus:ring-emerald-600 focus:ring-offset-2
                 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-950">
      </div>

      <select
        class="rounded-md border border-gray-300 dark:border-gray-700
               bg-white/80 dark:bg-gray-900/70 backdrop-blur
               px-3 py-2 text-sm text-gray-900 dark:text-gray-100
               focus:outline-none focus:ring-2 focus:ring-emerald-600 focus:ring-offset-2
               focus:ring-offset-gray-100 dark:focus:ring-offset-gray-950">
        <option value="">All statuses</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="pending">Pending</option>
      </select>

    </section>

    {% if students %}

    <!-- STUDENT GRID -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">

      {% for student in students %}
      {% set progress = (student.lessons_watched / student.courses_enrolled) * 100 if student.courses_enrolled > 0 else 0 %}

      <article
        class="rounded-2xl p-5
               bg-white/80 dark:bg-gray-900/70 backdrop-blur-lg
               border border-white/40 dark:border-white/10
               shadow-md
               transition
               md:hover:-translate-y-1 md:hover:shadow-lg">

        <!-- HEADER -->
        <div class="flex items-start gap-4 mb-5">

          <div
            class="w-12 h-12 rounded-full bg-emerald-600 text-white
                   flex items-center justify-center text-lg font-bold flex-shrink-0">
            {{ student.name[:1].upper() }}
          </div>

          <div class="flex-1 min-w-0 flex justify-between gap-2">
            <div class="min-w-0">
              <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100 truncate">
                {{ student.name }}
              </h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 truncate">
                {{ student.email }}
              </p>
            </div>

            <!-- STATUS BADGE -->
            {% if student.status == "active" %}
              <span class="h-fit px-2 py-0.5 text-xs font-semibold rounded-full
                           bg-emerald-100 text-emerald-700
                           dark:bg-emerald-900/40 dark:text-emerald-300">
                Active
              </span>
            {% elif student.status == "inactive" %}
              <span class="h-fit px-2 py-0.5 text-xs font-semibold rounded-full
                           bg-gray-200 text-gray-700
                           dark:bg-gray-800 dark:text-gray-300">
                Inactive
              </span>
            {% else %}
              <span class="h-fit px-2 py-0.5 text-xs font-semibold rounded-full
                           bg-amber-100 text-amber-700
                           dark:bg-amber-900/40 dark:text-amber-300">
                Pending
              </span>
            {% endif %}
          </div>
        </div>

        <!-- PROGRESS -->
        <div class="mb-5">
          <div class="flex justify-between items-center mb-1">
            <span class="text-xs font-medium text-gray-600 dark:text-gray-400">
              Progress
            </span>
            <span class="text-xs font-semibold text-gray-800 dark:text-gray-200">
              {{ progress|round(1) }}%
            </span>
          </div>

          <div class="h-2 w-full bg-gray-200 dark:bg-gray-800 rounded-full overflow-hidden">
            <div
              class="h-2 bg-emerald-500 rounded-full transition-all"
              style="width: {{ progress }}%">
            </div>
          </div>
        </div>

        <!-- INFO GRID -->
        <div class="grid grid-cols-2 gap-y-3 text-sm mb-6">
          <div>
            <p class="text-gray-500 dark:text-gray-400 font-medium">Watched</p>
            <p class="text-gray-900 dark:text-gray-100 font-semibold">
              {{ student.lessons_watched }}
            </p>
          </div>

          <div>
            <p class="text-gray-500 dark:text-gray-400 font-medium">Completed</p>
            <p class="text-emerald-600 dark:text-emerald-400 font-semibold">
              {{ student.courses_completed }}
            </p>
          </div>

          <div class="col-span-2">
            <p class="text-gray-500 dark:text-gray-400 font-medium">Last Active</p>
            <span
              class="inline-block mt-1 px-2 py-0.5 rounded-md text-xs font-medium
                     bg-gray-100 text-gray-700
                     dark:bg-gray-800 dark:text-gray-300">
              {{ student.last_active }}
            </span>
          </div>
        </div>

        <!-- ACTIONS (UPDATED WITH MESSAGE ICON) -->
        <div class="flex gap-2">
          <button
            class="flex-1 px-4 py-2 text-sm font-semibold rounded-md
                   bg-emerald-600 text-white
                   hover:bg-emerald-700
                   focus:outline-none focus:ring-2 focus:ring-emerald-600 focus:ring-offset-2
                   focus:ring-offset-gray-100 dark:focus:ring-offset-gray-950
                   transition">
            View Profile
          </button>
          
          <!-- MESSAGE ICON BUTTON -->
          <button
            onclick="openMessageModal('{{ student.name }}', '{{ student.email }}', {{ student.id }})"
            class="px-4 py-2 text-sm font-semibold rounded-md
                   bg-blue-600 text-white
                   hover:bg-blue-700
                   focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2
                   focus:ring-offset-gray-100 dark:focus:ring-offset-gray-950
                   transition
                   flex items-center justify-center"
            title="Send message to {{ student.name }}">
            <i class="fas fa-comment-alt"></i>
          </button>
        </div>

      </article>
      {% endfor %}

    </section>

    {% else %}

    <!-- EMPTY STATE -->
    <section
      class="max-w-xl mx-auto bg-white/80 dark:bg-gray-900/70 backdrop-blur-lg
             border border-white/40 dark:border-white/10
             rounded-xl p-8 text-center shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">
        No Students Enrolled
      </h3>
      <p class="text-gray-600 dark:text-gray-400 text-sm">
        This course has no enrolled students yet.
      </p>
    </section>

    {% endif %}

    <!-- FOOTER ACTION -->
    <div class="mt-auto pt-12 text-center">
      <a href="{{ url_for('instructor.dashboard') }}">
        <button
          class="inline-flex items-center px-6 py-2 text-sm font-medium
                 rounded-full border border-gray-300 dark:border-gray-700
                 text-gray-700 dark:text-gray-200
                 bg-white dark:bg-gray-900
                 hover:bg-gray-50 dark:hover:bg-gray-800
                 focus:outline-none focus:ring-2 focus:ring-emerald-600 focus:ring-offset-2
                 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-950
                 transition">
          ← Back to Dashboard
        </button>
      </a>
    </div>

  </div>
</div>

<!-- Include Message Modal -->
{% include 'messaging/message_modal.html' %}

{% endblock %}